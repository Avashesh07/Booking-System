<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="book_form.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Form</title>
</head>
<body>

    <!-- Div for form -->
    <div class="booking-container">
        <h2>Book a Slot</h2>
        <form id="bookingForm">
            <div class="user-details">
                <input type="text" id="name" name="name" placeholder="Full Name" required>
                <input type="email" id="email" name="email" placeholder="Email" required>
                <select id="club" name="club" required>
                    <!-- Options will be populated here -->
                </select>
            </div>
            
            <div class="datetime-picker">
                <!-- Embedded Calendar Component -->
                <div id='datepicker'></div>
                <!-- Hidden field to store the selected date -->
                <input type='hidden' id='bookingDate' name='bookingDate' required>
              
                <!-- Time slots -->
                <!-- You will need to implement this according to your requirements -->
                <!-- This is just a placeholder for example purposes -->
                <div class='time-picker'>
                    <div class='time-slots'></div> <!-- Slots will be populated dynamically -->
                </div>                     
              </div>
            <input type="submit" value="Submit">
        </form>
    </div>

    <script>
        // Fetch the clubs from the server and populate the dropdown list
        document.addEventListener('DOMContentLoaded', (event) => {
                    fetch('http://127.0.0.1:5001/clubs')
                    .then(response => response.json())
                    .then(data => {
                        const clubSelect = document.getElementById('club');
                        data.forEach(clubName => {
                            const option = document.createElement('option')
                            option.value = clubName;
                            option.text = clubName;
                            clubSelect.add(option);
                    });
                })
                .catch(error => console.error('Error', error));
        });

        $(function() {
            // Initialize the datepicker on the div
            $("#datepicker").datepicker({
                dateFormat: "yy-mm-dd",
                onSelect: function(dateText) {
                    $('#bookingDate').val(dateText);
                    fetchTimeSlots(dateText);  // Fetch slots when a new date is selected
                }
            });

            function fetchTimeSlots(date) {
                fetch(`http://localhost:5001/available_slots?date=${date}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No time slots available for the selected date');
                    }
                    return response.json();
                })
                .then(slots => {
                    const slotsContainer = document.querySelector('.time-slots');
                    slotsContainer.innerHTML = ''; // Clear previous slots
                    slots.forEach(slot => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.classList.add('time-slot');
                        button.textContent = slot;
                        button.onclick = function() {
                            document.getElementById('bookingTime').value = date + 'T' + slot + ':00Z';
                        };
                        slotsContainer.appendChild(button);
                    });
                })
                .catch(error => {
                    console.error(error);
                    const slotsContainer = document.querySelector('.time-slots');
                    slotsContainer.innerHTML = '<p>No available time slots for this date.</p>'; // Show message
                });
            }

            // Set the initial value of the hidden date input to today's date
            var today = new Date();
            var dateStr = $.datepicker.formatDate('yy-mm-dd', today);
            $('#bookingDate').val(dateStr);
            fetchTimeSlots(dateStr);  // Also fetch slots right after initializing the datepicker
        });



        // Select the container that holds the time slots
        const timeSlotsContainer = document.querySelector('.time-slots');

        // Add event listener to the time slots container
        timeSlotsContainer.addEventListener('click', (event) => {
                // Check if a time slot button was clicked
                if (event.target.classList.contains('time-slot')) {
                    // Remove the 'selected' class from all time slot buttons
                    timeSlotsContainer.querySelectorAll('.time-slot').forEach(slot => {
                        slot.classList.remove('selected');
                    });

                    // Add the 'selected' class to the clicked time slot button
                    event.target.classList.add('selected');

                    // Update the value of the hidden input with the selected time
                    const selectedTime = event.target.textContent || event.target.innerText;
                    document.getElementById('bookingTime').value = selectedTime;
                }
            });
        
        // Handle the form submission to make a POST request to the server
        

        document.getElementById('bookingForm').addEventListener('submit', (event) => {
            event.preventDefault();
    
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const club = document.getElementById('club');
            const clubId = club.options[club.selectedIndex].value;
            const clubName = club.options[club.selectedIndex].text; 

            // Retrieve the date and time
            const bookingDate = document.getElementById('bookingDate').value;
            const bookingTime = document.getElementById('bookingTime').value;

            // Combine date and time
            // The 'Z' indicates that this time is in UTC
            const formattedDateTime = bookingDate + 'T' + bookingTime + ':00Z';


            // The data object now includes the formattedDateTime
            const data = { name: name, email: email, time: formattedDateTime, club: clubId, club_name: clubName};


            
            fetch('http://localhost:5001/book', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })

            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        // Throw an error with the message from the server
                        throw new Error(errorData.error);
                    });
                }
                return response.json();
            })

            .then(data => {
                console.error('Success:', data);
                alert('Booking Successful!');
            })
    
            .catch((error) => {
                console.error('Error:', error);
                 // Display an alert with the error message
                 alert('Booking failed: ' + error.message);
            });
        });   
    
  

    </script>
</body>
</html>
